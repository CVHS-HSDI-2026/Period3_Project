import librosa
import numpy as np
import midiutil
import io
import pretty_midi
import json

wavFile = "home/songs/memphis-trap-memphis-trap-wav-349366.wav"

def hertzToMidiNotes(frequency):
    if frequency <= 0:
        return None #0?
    return int(round(69 + 12 * np.log2(frequency / 440.0)))

def wavToMidi(wavFile, hopLength=512):
    signal, sampleRate = librosa.load(wavFile)

    freq, soundPresent, soundProbability = librosa.pyin(
        y=signal,
        fmin=librosa.note_to_hz('C2'),
        fmax=librosa.note_to_hz('C7'),
        sr=sampleRate,
        hop_length=hopLength
    )

    tempo, beat_frames = librosa.beat.beat_track(y=signal, sr=sampleRate)
    tempo = float(tempo)
    seconds_per_beat = 60.0 / tempo

    midi = midiutil.MIDIFile(1)
    track = 0
    channel = 0
    midi.addTempo(track, 0, tempo)

    frameTimes = librosa.frames_to_time(
        np.arange(len(freq)),
        sr=sampleRate,
        hop_length=hopLength
    )

    notes = []
    current_note = None
    min_duration = 0.08

    for i, (f, time) in enumerate(zip(freq, frameTimes)):

        if soundPresent[i] and not np.isnan(f) and f > 0:
            midi_note = hertzToMidiNotes(f)

            if current_note is None:
                current_note = midi_note
                note_start_time = time

            elif midi_note != current_note:
                duration = time - note_start_time
                if duration > min_duration:
                    notes.append((current_note, note_start_time, duration))
                current_note = midi_note
                note_start_time = time

        else:
            if current_note is not None:
                duration = time - note_start_time
                if duration > min_duration:
                    notes.append((current_note, note_start_time, duration))
                current_note = None

    if current_note is not None:
        duration = frameTimes[-1] - note_start_time
        if duration > min_duration:
            notes.append((current_note, note_start_time, duration))

    velocity = 100
    for note, start_time, duration in notes:
        start_beat = start_time / seconds_per_beat
        duration_beats = duration / seconds_per_beat
        midi.addNote(track, channel, note, start_beat, duration_beats, velocity)

    midi_buffer = io.BytesIO()
    midi.writeFile(midi_buffer)
    midi_bytes = midi_buffer.getvalue()

    return midi_bytes

def midi_to_json(midi_bytes):
    midi_data = pretty_midi.PrettyMIDI(io.BytesIO(midi_bytes))

    midi_dict = {
        "tempo": float(midi_data.estimate_tempo()),
        "instruments": []
    }

    for instrument in midi_data.instruments:
        instrument_data = {
            "name": str(instrument.name),
            "program": int(instrument.program),
            "is_drum": bool(instrument.is_drum),
            "notes": []
        }

        for note in instrument.notes:
            instrument_data["notes"].append({
                "pitch": int(note.pitch),
                "start": float(note.start),
                "end": float(note.end),
                "velocity": int(note.velocity)
            })

        midi_dict["instruments"].append(instrument_data)

    return midi_dict

midi_bytes = wavToMidi(wavFile)

midi_json = midi_to_json(midi_bytes)

with open("output.json", "w") as f:
    json.dump(midi_json, f, indent = 4)
